log "$BLUE" "üîÑ Starting Tailscale daemon..."

# Ensure /run/tailscale exists
mkdir -p /run/tailscale

# Start Tailscale daemon
"$INSTALL_DIR/bin/tailscaled" --state="$INSTALL_DIR/tailscaled.state" --socket="$INSTALL_DIR/tailscaled.sock" >> /userdata/system/tailscale/tailscale.log 2>&1 &

# Wait for tailscaled to initialize
sleep 5

# Ensure it's running before continuing
if ! pgrep -f tailscaled > /dev/null; then
    log "$RED" "‚ùå Tailscale daemon failed to start!"
    cat /userdata/system/tailscale/tailscale.log
    exit 1
fi

log "$GREEN" "‚úÖ Tailscale daemon started successfully!"

# Bring up Tailscale with authentication
log "$BLUE" "üîÑ Bringing Tailscale online..."
"$INSTALL_DIR/bin/tailscale" --socket="$INSTALL_DIR/tailscaled.sock" up --authkey="$AUTH_KEY" --hostname="$HOSTNAME" --advertise-tags="$TAG" --ssh || { 
    log "$RED" "‚ùå Tailscale setup failed!"; 
    exit 1; 
}

log "$GREEN" "‚úÖ Tailscale is now online!"
