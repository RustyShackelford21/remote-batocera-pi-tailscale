#!/bin/sh

# Prompt for Tailscale auth key
echo "Enter your Tailscale auth key (e.g., tskey-auth-...):"
read -r AUTH_KEY

# Prompt for hostname
echo "Enter desired hostname (e.g., testkey):"
read -r HOSTNAME

# Prompt for tag (default: tag:ssh-batocera-1)
echo "Enter Tailscale tag (press Enter for default 'tag:ssh-batocera-1'):"
read -r TAG
TAG=${TAG:-tag:ssh-batocera-1}

# Auto-detect subnet from ip route
SUBNET=$(ip route | grep "default via" | grep -oE "[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+/[0-9]+" | head -n 1)
if [ -n "$SUBNET" ]; then
    ADVERTISE_ROUTES="--advertise-routes=$SUBNET"
    echo "Detected subnet: $SUBNET"
else
    ADVERTISE_ROUTES=""
    echo "No subnet detected, proceeding without advertising routes"
fi

# Clean up existing keys
rm -f /root/.ssh/id_dropbear /root/.ssh/id_dropbear_openssh /etc/dropbear/authorized_keys

# Generate new Dropbear key
dropbearkey -t ed25519 -f /root/.ssh/id_dropbear
dropbearconvert dropbear openssh /root/.ssh/id_dropbear /root/.ssh/id_dropbear_openssh
dropbearkey -y -f /root/.ssh/id_dropbear | grep "ssh-ed25519" > /etc/dropbear/authorized_keys

# Set permissions
chmod 600 /root/.ssh/id_dropbear /root/.ssh/id_dropbear_openssh /etc/dropbear/authorized_keys
mkdir -p /etc/dropbear
chmod 700 /etc/dropbear

# Stop existing services
pkill -f dropbear
pkill -f tailscaled
sleep 2

# Start Dropbear with key-only auth
dropbear -s -p 22 &>/dev/null &
sleep 1
pgrep dropbear || echo "Dropbear failed to start"

# Set up TUN device
modprobe tun
[ ! -c /dev/net/tun ] && mknod /dev/net/tun c 10 200 && chmod 666 /dev/net/tun
sleep 2

# Start Tailscale
/userdata/system/tailscale/bin/tailscaled --state=/userdata/system/tailscaled.state --socket=/userdata/system/tailscaled.sock &>/dev/null &
sleep 30

# Configure Tailscale with user inputs and subnet
/userdata/system/tailscale/bin/tailscale --socket=/userdata/system/tailscaled.sock up --authkey="$AUTH_KEY" --hostname="$HOSTNAME" --advertise-tags="$TAG" --accept-routes $ADVERTISE_ROUTES &>/dev/null || echo "Tailscale up failed"
sleep 5

# Log Tailscale status
/userdata/system/tailscale/bin/tailscale --socket=/userdata/system/tailscaled.sock status > /userdata/system/tailscale_status.log 2>&1 || echo "Tailscale status check failed"

# Save overlay for /etc/dropbear
batocera-save-overlay

# Copy the OpenSSH key to a downloadable location
cp /root/.ssh/id_dropbear_openssh /userdata/system/tailscale_key_openssh

echo "Script complete. Reboot to test persistence."
echo "Download the private key from /userdata/system/tailscale_key_openssh via SCP:"
echo "scp root@192.168.50.5:/userdata/system/tailscale_key_openssh C:\\Users\\Willi\\.ssh\\id_dropbear_openssh"
echo "For other devices (e.g., iPhone Terminus), copy this key after downloading."
